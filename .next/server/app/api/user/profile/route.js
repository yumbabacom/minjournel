(()=>{var e={};e.id=397,e.ids=[397],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},2518:e=>{"use strict";e.exports=require("mongodb")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3692:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>v,routeModule:()=>h,serverHooks:()=>x,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>y});var s={};t.r(s),t.d(s,{GET:()=>f,PUT:()=>w});var o=t(6559),n=t(8088),a=t(7719),i=t(2190),u=t(3834),l=t(7652),c=t(3205),d=t.n(c),p=t(5663);let m=process.env.JWT_SECRET||"your-secret-key-change-in-production";async function f(e){try{let r,t=e.headers.get("authorization");if(!t||!t.startsWith("Bearer "))return i.NextResponse.json({error:"No token provided"},{status:401});let s=t.substring(7);try{r=d().verify(s,m)}catch(e){return i.NextResponse.json({error:"Invalid token"},{status:401})}await (0,u.Ay)();let o=await l.A.findById(r.userId);if(!o)return i.NextResponse.json({error:"User not found"},{status:404});return i.NextResponse.json({success:!0,user:o.toPublicJSON()})}catch(e){return console.error("Error fetching user profile:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function w(e){try{let r,t=e.headers.get("authorization");if(!t||!t.startsWith("Bearer "))return i.NextResponse.json({error:"No token provided"},{status:401});let s=t.substring(7);try{console.log("Verifying token with secret:",m?"Secret available":"No secret"),r=d().verify(s,m),console.log("Token verified successfully for userId:",r.userId)}catch(e){return console.error("JWT verification error:",e.message),i.NextResponse.json({error:"Invalid token: "+e.message},{status:401})}let{fullName:o,email:n,currentPassword:a,newPassword:c,confirmPassword:f}=await e.json();await (0,u.Ay)();let w=await l.A.findById(r.userId).select("+password");if(!w)return i.NextResponse.json({error:"User not found"},{status:404});let h={};if(o&&""!==o.trim()&&(h.fullName=o.trim()),n&&""!==n.trim()&&n.toLowerCase()!==w.email){if(await l.A.findOne({email:n.toLowerCase(),_id:{$ne:w._id}}))return i.NextResponse.json({error:"Email already exists"},{status:400});h.email=n.toLowerCase()}if(c&&""!==c.trim()){if(!a)return i.NextResponse.json({error:"Current password is required to change password"},{status:400});if(!await w.comparePassword(a))return i.NextResponse.json({error:"Current password is incorrect"},{status:400});if(c.length<6)return i.NextResponse.json({error:"New password must be at least 6 characters long"},{status:400});if(c!==f)return i.NextResponse.json({error:"New passwords do not match"},{status:400});h.password=await p.Ay.hash(c,12)}if(0===Object.keys(h).length)return i.NextResponse.json({error:"No valid updates provided"},{status:400});let g=await l.A.findByIdAndUpdate(r.userId,{$set:{...h,updatedAt:new Date}},{new:!0,runValidators:!0});return i.NextResponse.json({success:!0,message:"Profile updated successfully",user:g.toPublicJSON()})}catch(e){if(console.error("Error updating user profile:",e),"ValidationError"===e.name){let r=Object.values(e.errors).map(e=>e.message);return i.NextResponse.json({error:r.join(", ")},{status:400})}return i.NextResponse.json({error:"Internal server error"},{status:500})}}let h=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/user/profile/route",pathname:"/api/user/profile",filename:"route",bundlePath:"app/api/user/profile/route"},resolvedPagePath:"/home/runner/work/minjournel/minjournel/app/api/user/profile/route.js",nextConfigOutput:"",userland:s}),{workAsyncStorage:g,workUnitAsyncStorage:y,serverHooks:x}=h;function v(){return(0,a.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:y})}},3834:(e,r,t)=>{"use strict";let s;t.d(r,{$V:()=>d,Ay:()=>p});var o=t(6037),n=t.n(o),a=t(2518);let i=process.env.MONGODB_URI||"mongodb+srv://tmuneebanjum:A5Y1enJBJcDVwPrt@jorn.nx9fd28.mongodb.net/smartsave",u="trading-journal";if(!i)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let l=global.mongoose;async function c(){if(l.conn)return l.conn;l.promise||(l.promise=n().connect(i,{bufferCommands:!1}).then(e=>e));try{l.conn=await l.promise}catch(e){throw l.promise=null,e}return l.conn}async function d(){try{let e=await s;console.log("Connected to MongoDB successfully, using database:",u);let r=e.db(u);return{client:e,db:r}}catch(e){throw console.error("Failed to connect to database:",e),e}}l||(l=global.mongoose={conn:null,promise:null}),s=new a.MongoClient(i).connect();let p=c},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5511:e=>{"use strict";e.exports=require("crypto")},6037:e=>{"use strict";e.exports=require("mongoose")},6487:()=>{},7652:(e,r,t)=>{"use strict";t.d(r,{A:()=>i});var s=t(6037),o=t.n(s),n=t(5663);let a=new(o()).Schema({fullName:{type:String,required:[!0,"Please provide a full name"],maxlength:[60,"Name cannot be more than 60 characters"]},email:{type:String,required:[!0,"Please provide an email"],unique:!0,lowercase:!0,match:[/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/,"Please provide a valid email"]},password:{type:String,required:[!0,"Please provide a password"],minlength:[6,"Password must be at least 6 characters"],select:!1},createdAt:{type:Date,default:Date.now},lastLogin:{type:Date},isActive:{type:Boolean,default:!0}});a.pre("save",async function(e){if(!this.isModified("password"))return e();try{let r=await n.Ay.hash(this.password,12);this.password=r,e()}catch(r){e(r)}}),a.methods.comparePassword=async function(e){return await n.Ay.compare(e,this.password)},a.methods.toPublicJSON=function(){let e=this.toObject();return delete e.password,e};let i=o().models.User||o().model("User",a)},7910:e=>{"use strict";e.exports=require("stream")},8335:()=>{},8354:e=>{"use strict";e.exports=require("util")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9428:e=>{"use strict";e.exports=require("buffer")}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[447,580,205,663],()=>t(3692));module.exports=s})();